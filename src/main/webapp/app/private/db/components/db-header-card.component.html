<p-card>
  <header class="flex flex-wrap align-items-center justify-content-between gap-3">
    <div class="flex min-w-0 align-items-center gap-2 flex-grow-1">
      <div class="flex justify-content-center align-items-center w-3rem h-3rem border-round-xl bg-blue-500 align-items-center text-white shadow-1">
        <span class="text-sm font-semibold">DB</span>
      </div>
      <div>
        <div *ngIf="!isEditingProject" class="flex gap-2">
          <div class="flex justify-content-center align-items-center px-2 h-3rem border-round-xl bg-gray-400 align-items-center text-white shadow-1 cursor-pointer" (click)="editProject()">
            <span class="text-sm font-semibold white-space-nowrap">{{database.project.name}}</span>
          </div>
        </div>
        <div *ngIf="isEditingProject" class="flex gap-3 align-items-center border-round-xl bg-gray-50 text-white shadow-1">
          <div class="flex-grow-1 max-w-30rem">
            <p-dropdown [options]="projects" [(ngModel)]="newProject" optionLabel="name"
                        optionDisabled="disabled" styleClass="w-15rem"
                        id="project" inputId="project" appendTo="body">
              <ng-template let-item pTemplate="item">
                <div class="flex flex-row column-gap-2 align-items-center">
                  <span>{{ item.name }}</span>
                </div>
              </ng-template>
              <ng-template pTemplate="selectedItem">
                <div class="flex flex-row column-gap-2 align-items-center">
                  <span>{{ newProject.name }}</span>
                </div>
              </ng-template>
            </p-dropdown>
          </div>
          <div class="flex gap-2 pr-3">
            <a (click)="saveProject()" class="ml-2"><i class="pi pi-check text-success text-green-700"></i></a>
            <a (click)="cancelProjectEdit()" class="ml-2"><i class="pi pi-times text-red-700"></i></a>
          </div>
        </div>
      </div>
      <div class="min-w-0 flex-grow-1">
        <div class="flex align-items-center gap-2">
          <ng-container *ngIf="!isEditingName">
            <p class="text-xl font-semibold">{{ database.name }}</p>
            <a class="inline-flex align-items-center justify-content-center" (click)="editName()">
              <i class="pi pi-pencil" style="font-size: 1rem"></i>
            </a>
          </ng-container>
          <ng-container *ngIf="isEditingName">
            <input type="text" pInputText [(ngModel)]="newName" (keyup.enter)="saveName()"
                   (keyup.escape)="cancelNameEdit()"
                   class="" style="font-size: inherit; font-weight: inherit; height: 2rem;" />
            <a (click)="saveName()" class="ml-2">
              <i class="pi pi-check text-success text-green-700"></i></a>
            <a (click)="cancelNameEdit()" class="ml-2">
              <i class="pi pi-times text-red-700"></i></a>
          </ng-container>
        </div>

        <!-- Database Description -->
        <div class="mt-1">
          <div *ngIf="!isEditingDescription" class="flex gap-2 align-items-center">
            <span class="text-sm text-600">{{ database.description ? database.description : "[Describe your database]" }}</span>
            <a (click)="editDescription()" class="inline-flex align-items-center justify-content-center">
              <i-lucide [img]="Pencil" class="w-1rem h-1rem text-gray-400"></i-lucide>
            </a>
          </div>
          <div *ngIf="isEditingDescription" class="select-none w-full flex gap-2 align-items-end">
            <div class="flex-grow-1">
              <textarea pInputTextarea
                        rows="2"
                        type="text"
                        pInputText placeholder="Database description"
                        [(ngModel)]="newDescription"
                        (keyup.enter)="saveDescription()"
                        (keyup.escape)="cancelDescriptionEdit()"
                        style="font-size: inherit; font-weight: inherit; width: 100%"></textarea>
            </div>
            <div class="flex gap-1" *ngIf="isEditingDescription">
              <a (click)="saveDescription()" class="ml-2"><i class="pi pi-check text-success"></i></a>
              <a (click)="cancelDescriptionEdit()" class="ml-2"><i class="pi pi-times text-danger"></i></a>
            </div>
          </div>
        </div>

        <div *ngIf="database?.status === DatabaseStatus.DEPLOYING">
          <i-lucide [img]="CircleCheck" class="pl-2 w-1rem h-1rem"></i-lucide>
          <small class="m-0">
            Once the deployment process is finished you will be able to start your database.
          </small>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex align-items-center gap-2">
      @if (showStatus) {
        <div class="flex align-items-center gap-2">
          <!-- Deployment Status Tag -->
          <div *ngIf="database?.status; else statusLoading">
            <p-tag [value]="database.status"
                   [severity]="database.status === DatabaseStatus.ERROR ? 'danger' :
                       database.status === DatabaseStatus.DEPLOYED ? 'success' :
                       database.status === DatabaseStatus.DEPLOYING ? 'warning' : 'secondary'"
                   [pTooltip]="database.status"
                   class="select-none"></p-tag>
          </div>
          <ng-template #statusLoading>
            <i class="pi pi-spinner pi-spin" style="font-size: 1rem"></i>
          </ng-template>

          <!-- Running Status Tag (inline) -->
          <div *ngIf="database.status === DatabaseStatus.DEPLOYED">
            <div *ngIf="dbStatus; else runningStatusLoading">
              @if (dbStatus.stage) {
                <p-tag [value]="dbStatus.stage"
                       class="select-none"
                       [pTooltip]="dbStatus.message || dbStatus.stage"
                       tooltipPosition="top"></p-tag>
              } @else {
                <p-tag value="UNKNOWN"
                       class="select-none"
                       severity="secondary"
                       pTooltip="The running status is unknown."
                       tooltipPosition="top"></p-tag>
              }
            </div>
            <ng-template #runningStatusLoading>
              <i class="pi pi-spinner pi-spin" style="font-size: 1rem"></i>
            </ng-template>
          </div>
        </div>

        <div class="mx-1 h-6 w-1rem"></div>
      }

      @if (showControls && database.status === DatabaseStatus.DEPLOYED) {
        <sm-db-control
          [db]="database"
          [dbStatus]="dbStatus"
          (controlFinished)="handleControlFinished()">
        </sm-db-control>
        <div class="mx-1 h-6 w-1rem"></div>
      }

      <div>
        <div class="flex flex-row column-gap-3 align-items-center">
          <a (click)="deleteDatabase($event)" pTooltip="Delete Database" tooltipPosition="left"><i
            class="pi pi-trash text-red-500 text-xl"></i></a>
        </div>
        <p-confirmPopup key="confirmDelete"></p-confirmPopup>
      </div>
    </div>
  </header>
</p-card>

<div class="grid gap-2 mt-2">
  <!-- Endpoints & Password (Full Width) -->
  <div *ngIf="ingressHostName || internalEndpoint || password" class="col-12 flex flex-column gap-3">
    @if (ingressHostName) {
      <p-card styleClass="min-h-7rem">
        <div class="flex align-items-center gap-2">
          <i-lucide [img]="Globe" class="w-1rem h-1rem"></i-lucide>
          <p class="text-sm font-semibold">Public endpoint</p>
        </div>
        <div class="mt-3">
          <div class="flex gap-2 align-items-center mb-2">
            <span class="text-green-700 font-semibold flex-1">
              {{ ingressHostName + ':2222' }}
            </span>
            <button
              pButton
              type="button"
              icon="pi pi-copy"
              [text]="true"
              size="small"
              pTooltip="Copy endpoint"
              tooltipPosition="top"
              (click)="copyToClipboard(ingressHostName + ':2222', 'Endpoint')">
            </button>
          </div>
          <div class="flex gap-2 align-items-center p-2 border-round surface-ground">
            <code class="text-xs flex-1 text-600">psql -h {{ ingressHostName }} -p 2222 -U postgres</code>
            <button
              pButton
              type="button"
              icon="pi pi-copy"
              [text]="true"
              size="small"
              pTooltip="Copy psql command"
              tooltipPosition="top"
              (click)="copyToClipboard('psql -h ' + ingressHostName + ' -p 2222 -U postgres', 'psql command')">
            </button>
          </div>
        </div>
      </p-card>
    }

    @if (internalEndpoint) {
      <p-card>
        <div class="flex align-items-center gap-2">
          <i-lucide [img]="Network" class="w-1rem h-1rem"></i-lucide>
          <p class="text-sm font-semibold">Internal endpoint</p>
        </div>
        <div class="mt-3 flex gap-2 align-items-center">
          <p *ngIf="internalEndpoint" class="text-green-700 font-semibold flex-1">
            {{ serviceName(internalEndpoint, '5432') + ':5432' }}
          </p>
          <button
            pButton
            type="button"
            icon="pi pi-copy"
            [text]="true"
            size="small"
            pTooltip="Copy endpoint"
            tooltipPosition="top"
            (click)="copyToClipboard(serviceName(internalEndpoint, '5432') + ':5432', 'Internal endpoint')">
          </button>
        </div>
      </p-card>
    }

    @if (password) {
      <p-card>
        <div class="flex align-items-center gap-2">
          <i class="pi pi-key"></i>
          <p class="text-sm font-semibold">Password</p>
        </div>
        <div class="mt-3">
          <div class="flex gap-2 align-items-center mt-2">
            <input
              type="password"
              pInputText
              [value]="password"
              readonly
              class="flex-1"
              #passwordInput />
            <button
              pButton
              type="button"
              icon="pi pi-copy"
              [text]="true"
              size="small"
              pTooltip="Copy password"
              tooltipPosition="top"
              (click)="copyPassword()">
            </button>
          </div>
        </div>
      </p-card>
    }
  </div>
</div>
