<sm-page-loader [message]="'Starting fast model serving...'">
  <ng-template>
    <div class="relative">
      <div class="absolute top-0 right-0 z-5">
        <button
          pButton
          icon="pi pi-sliders-h"
          class="p-button-text"
          (click)="controlsVisible = true"
        ></button>
      </div>
    </div>

    <div class="flex flex-column" style="height: calc(100vh - 7rem);">

      <div class="flex-1 overflow-hidden">
        <p-scrollPanel #scrollPanel styleClass="w-full h-full">
          <div class="p-3">
            <div class="mx-auto w-full md:w-9 lg:w-7">

              <div *ngFor="let msg of messages()" class="mb-3">

                <div *ngIf="msg.role === 'user'" class="flex justify-content-end">
                  <div class="p-3 border-round-lg bg-blue-50 max-w-70">
                    <!-- User Files -->
                    <div *ngIf="msg.files && msg.files.length > 0" class="mb-2">
                      <div *ngFor="let file of msg.files" class="mb-2">
                        <!-- Image files -->
                        <div *ngIf="file.type === 'image'" class="border-round-lg overflow-hidden border-1 border-200">
                          <img [src]="file.url || file.preview" [alt]="file.name"
                               class="w-full max-w-15rem border-round-lg">
                          <div class="p-2 text-xs text-600">{{ file.name }}</div>
                        </div>

                        <!-- Audio files -->
                        <div *ngIf="file.type === 'audio'"
                             class="p-2 border-round-lg border-1 border-200 bg-white flex align-items-center gap-2">
                          <i class="pi pi-volume-up text-blue-500"></i>
                          <div class="flex-1">
                            <div class="text-sm font-medium">{{ file.name }}</div>
                            <audio controls class="w-full mt-1"
                                   [src]="'data:' + file.mimeType + ';base64,' + file.base64">
                              Your browser does not support audio playback.
                            </audio>
                          </div>
                        </div>

                        <!-- Video files -->
                        <div *ngIf="file.type === 'video'" class="border-round-lg overflow-hidden border-1 border-200">
                          <video controls class="w-full max-w-15rem border-round-lg"
                                 [src]="'data:' + file.mimeType + ';base64,' + file.base64">
                            Your browser does not support video playback.
                          </video>
                          <div class="p-2 text-xs text-600">{{ file.name }}</div>
                        </div>

                      </div>
                    </div>
                    {{ msg.content }}
                  </div>
                </div>

                <div *ngIf="msg.role === 'assistant'" class="flex">
                  <div class="mr-auto max-w-70">

                    <div *ngIf="msg.thinking" class="mb-2">
                      <div class="thinking-block border-round-lg overflow-hidden">
                        <div
                          class="thinking-header p-3 cursor-pointer flex align-items-center justify-content-between"
                          (click)="toggleThinking(msg)"
                        >
                          <div class="flex align-items-center gap-2">
                            <span class="text-xl">ðŸ’­</span>
                            <span class="font-semibold text-sm">Thinking process</span>
                          </div>
                          <i [ngClass]="msg.thinkingExpanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"></i>
                        </div>
                        <div *ngIf="msg.thinkingExpanded"
                             class="thinking-content p-3 surface-0 border-top-1 border-200">
                          <div class="text-sm text-600 font-monospace white-space-pre-wrap">{{ msg.thinking }}</div>
                        </div>
                      </div>
                    </div>

                    <div class="p-3 border-round-lg surface-0 shadow-1">
                      <markdown [data]="msg.content"></markdown>
                    </div>

                    <div class="flex gap-2 mt-2">
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-pencil"
                              (click)="onEdit(msg)"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-copy"
                              (click)="copy(msg.content)"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-volume-up"
                              (click)="speak(msg.content)"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-info-circle"
                              [pTooltip]="getTooltipContent(msg)" tooltipPosition="left"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-thumbs-up"
                              (click)="like(msg)"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-thumbs-down"
                              (click)="dislike(msg)"></button>
                      <button pButton class="p-button-text p-button-sm" icon="pi pi-refresh"
                              (click)="regenerate(msg)"></button>
                    </div>
                  </div>
                </div>

              </div>

              <div *ngIf="streaming()" class="mb-3">
                <div class="mr-auto max-w-70">

                  <div *ngIf="liveThinking()" class="mb-2">
                    <div class="thinking-block streaming border-round-lg overflow-hidden">
                      <div class="thinking-header p-3 flex align-items-center gap-2">
                        <span class="text-xl">ðŸ’­</span>
                        <span class="font-semibold text-sm">Thinking...</span>
                        <i class="pi pi-spin pi-spinner ml-2"></i>
                      </div>
                      <div class="thinking-content p-3 surface-0 border-top-1 border-200">
                        <div class="text-sm text-600 font-monospace white-space-pre-wrap">{{ liveThinking() }}</div>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-round-lg surface-0 shadow-1">
                    <markdown [data]="live()"></markdown>
                    <span class="cursor ml-1 text-primary">â–Š</span>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </p-scrollPanel>
      </div>

      <!-- INPUT BAR - Fixed at bottom -->
      <div class="flex-shrink-0 p-3 surface-ground">
        <div class="mx-auto w-full md:w-9 lg:w-7">
          @if (errorMessage()) {
            <div class="mb-2">
              <p-message
                severity="error"
                [text]="errorMessage()!"
                styleClass="w-full"
                (click)="clearError()"
              >
              </p-message>
            </div>
          }

          <!-- File attachments preview -->
          <div *ngIf="attachedFiles().length > 0" class="mb-2 flex flex-wrap gap-2">
            <div *ngFor="let file of attachedFiles(); let i = index"
                 class="relative border-round-lg border-1 border-200 bg-white overflow-hidden">

              <!-- Image preview -->
              <div *ngIf="file.type === 'image'" class="relative">
                <img [src]="file.preview" [alt]="file.name" class="w-4rem h-4rem object-cover">
                <button
                  pButton
                  icon="pi pi-times"
                  class="p-button-text p-button-sm p-button-rounded absolute top-0 right-0"
                  style="width: 1.5rem; height: 1.5rem;"
                  (click)="removeFile(i)">
                </button>
              </div>

              <!-- PDF preview -->

            </div>
          </div>

          <div class="flex align-items-center gap-2 p-3 border-round-3xl surface-0 shadow-3">

            <!-- File upload button -->
            @if (supportsFiles()) {
              <input
                #fileInput
                type="file"
                class="hidden"
                [multiple]="!maxFiles() || maxFiles() > 1"
                accept="image/*,audio/*,video/*"
                (change)="onFilesSelected($event)"
              >
              <button
                pButton
                icon="pi pi-paperclip"
                [text]="true"
                [rounded]="true"
                severity="secondary"
                class="flex-shrink-0"
                (click)="fileInput.click()"
                [disabled]="streaming()"
              ></button>
            }
            <textarea
              pInputTextarea
              #messageInput
              [autoResize]="true"
              [(ngModel)]="draft"
              placeholder="Type a message..."
              (keydown.enter)="onEnter($any($event))"
              [rows]="1"
              class="flex-1 border-none surface-0"
            ></textarea>

            <button
              pButton
              [icon]="streaming() ? 'pi pi-stop' : 'pi pi-send'"
              [rounded]="true"
              (click)="send()"
              [disabled]="(!draft.trim() && attachedFiles().length === 0) && !streaming()"
              class="flex-shrink-0"
            ></button>

          </div>
        </div>
      </div>

    </div>
  </ng-template>
</sm-page-loader>

<!-- Controls Sidebar -->
<p-sidebar
  [(visible)]="controlsVisible"
  position="right"
  appendTo="body"
  styleClass="w-20rem p-0 shadow-2"
>
  <div class="p-4">

    <!-- HEADER -->
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="text-xl font-semibold m-0">Chat Controls</h2>
    </div>

    <!-- SYSTEM PROMPT -->
    <div class="mb-4">
      <h3 class="text-base font-medium mb-2">System Prompt</h3>
      <textarea
        pInputTextarea
        [(ngModel)]="systemPrompt"
        rows="4"
        class="w-full border-none shadow-none surface-ground"
        placeholder="Enter system prompt..."
      ></textarea>
    </div>

    <!-- ENABLE THINKING TOGGLE -->
    <div class="mb-4 p-3 border-round-lg surface-50">
      <div class="flex align-items-center justify-content-between mb-2">
        <label class="text-base font-medium m-0">Enable Thinking</label>
        <p-inputSwitch [(ngModel)]="enableThinking"></p-inputSwitch>
      </div>
      <small class="text-color-secondary text-sm">Show model's reasoning process</small>
    </div>

    <hr class="my-4">

    <!-- ADVANCED PARAMS -->
    <div>
      <h3 class="text-base font-medium mb-2">Advanced Params</h3>

      <ng-container *ngFor="let item of advancedParams">
        <div class="flex mb-2 text-sm pt-1">
          <div class="w-6 text-left">
            <span>{{ item.label }}</span>
          </div>
          <div class="w-6 text-right">
            <span
              class="cursor-pointer text-blue-600"
              (click)="toggleCustom(item)"
            >
              {{ item.isCustom ? 'Custom' : 'Default' }}
            </span>
          </div>
        </div>
        <div *ngIf="item.isCustom" class="mb-1">

          <!-- NUMBER INPUT -->
          <input
            *ngIf="item.type === 'number'"
            type="number"
            pInputText
            class="w-6rem text-right text-sm border-none shadow-none surface-ground"
            [(ngModel)]="item.value"
            (input)="onValueChange(item)"
          />

          <!-- STRING INPUT -->
          <input
            *ngIf="item.type === 'string'"
            type="text"
            pInputText
            class="w-8rem text-right text-sm border-none shadow-none surface-ground"
            [(ngModel)]="item.value"
            (input)="onValueChange(item)"
          />

          <input
            *ngIf="item.type === 'list'"
            type="text"
            pInputText
            placeholder="a,b,c"
            class="w-8rem text-right text-sm border-none shadow-none surface-ground"
            [(ngModel)]="item.value"
            (input)="onValueChange(item)"
          />

          <!-- BOOLEAN SELECT -->
          <select
            *ngIf="item.type === 'boolean'"
            class="w-6rem text-right text-sm border-none border-bottom-1 surface-border shadow-none surface-ground p-1 border-noround"
            [(ngModel)]="item.value"
            (change)="onValueChange(item)"
          >
            <option [ngValue]="true">true</option>
            <option [ngValue]="false">false</option>
          </select>

          <!-- ENUM SELECT -->
          <select
            *ngIf="item.type === 'enum'"
            class="w-8rem text-right text-sm border-none border-bottom-1 surface-border shadow-none surface-ground p-1 border-noround"
            [(ngModel)]="item.value"
            (change)="onValueChange(item)"
          >
            <option *ngFor="let opt of item.options" [ngValue]="opt">{{ opt }}</option>
          </select>

        </div>
      </ng-container>

    </div>

  </div>
</p-sidebar>
