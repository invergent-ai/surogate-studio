<sm-card [header]="title()" [icon]="Database" iconClass="text-blue-500">
  <ng-template pTemplate="toolbar">
    <button pButton type="button" size="small" severity="secondary" (click)="add()" *ngIf="formArray().length === 0 || (formArray().length > 0 && multiple())">
      <div class="flex gap-2 align-items-center">
        <i-lucide [img]="Plus" class="w-1rem h-1rem"></i-lucide>
        <span>Add dataset</span>
      </div>
    </button>
  </ng-template>

  <div class="card surface-50 border-round-xl border-1 border-300" style="padding: 3px;">
    <p-table [value]="formArrayForDisplay()" [dataKey]="$any(uniqFormEntry)"
             rowExpandMode="single" [expandedRowKeys]="expandedRows()"
             (onRowExpand)="onRowExpand($event)"
             (onRowCollapse)="onRowCollapse($event)"
             [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5rem"></th>
          <th class="text-500"><sm-label-tooltip [tooltip]="DATASET_REPOSITORY">Repository</sm-label-tooltip></th>
          <th class="text-500"><sm-label-tooltip [tooltip]="DATASET_REF">Branch/Tag/Commit</sm-label-tooltip></th>
          <th class="text-500">Format</th>
          <th class="text-500">Subset</th>
          <th class="text-500"><sm-label-tooltip [tooltip]="DATASET_SPLIT">Split</sm-label-tooltip></th>
          <th class="text-500">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-dataset let-expanded="expanded">
        <tr>
          <td>
            <button pButton [pRowToggler]="dataset" size="small" [text]="true" [plain]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td>{{ dataset?.value.repoId }}</td>
          <td>{{ dataset?.value.ref?.id }}</td>
          <td>{{ dsFormatLabel(dataset?.value.type) }}</td>
          <td>{{ dataset?.value.subset }}</td>
          <td>{{ dataset?.value.split }}</td>
          <td style="width: 10%">
            <div class="flex gap-2">
              <a class="text-700 hover:text-red-700 text-red-300" (click)="remove(dataset)">
                <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
              </a>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion">
        <tr>
          <td colspan="7" class="p-1">
            <form class="p-2" [formGroup]="currentForm()">
              <div class="formgrid grid text-sm p-fluid">
<!--                Repo-->
                <div class="field col-12 md:col-6">
                  <sm-label-tooltip [tooltip]="DATASET_REPOSITORY">Repository</sm-label-tooltip>
                  <div class="flex">
                    <sm-repo-selector formControlName="repoId" [repoType]="'dataset'" class="col"></sm-repo-selector>
                  </div>
                </div>
<!--                Branch-->
                <div class="field col-12 md:col-6">
                  <sm-label-tooltip [tooltip]="DATASET_REF">Branch/Tag/Commit</sm-label-tooltip>
                  <div class="flex">
                    <sm-ref-selector [repoId]="currentForm().get('repoId').value"
                                     id="ref" formControlName="ref" [canSelect]="!!currentForm().get('repoId').value"
                                     type="any" buttonSize="small" class="col"></sm-ref-selector>
                  </div>
                </div>
<!--                Type-->
                <div class="field col-12 md:col-6">
                  <sm-label-tooltip [tooltip]="DATASET_FORMAT">Dataset Format</sm-label-tooltip>
                  <p-dropdown [options]="dsFormats()" formControlName="type" appendTo="body"></p-dropdown>
                </div>
<!--                Subset-->
                <div class="field col-12 md:col-2">
                  <label>Subset</label>
                  <input pInputText type="text" id="subset" formControlName="subset">
                </div>
<!--                Split-->
                <div class="field col-12 md:col-2">
                  <sm-label-tooltip [tooltip]="DATASET_SPLIT">Split</sm-label-tooltip>
                  <input pInputText type="text" id="split" formControlName="split">
                </div>
<!--                Samples-->
                <div class="field col-12 md:col-2">
                  <sm-label-tooltip [tooltip]="DATASET_MAX_RECORDS">Max Records</sm-label-tooltip>
                  <input pInputText type="text" id="samples" formControlName="samples">
                </div>
                @if (currentForm().value.type === 'text') {
<!--                  Text field-->
                  <div class="field col-12 md:col-6">
                    <sm-label-tooltip [tooltip]="DATASET_TEXT_COLUMN">Text Field</sm-label-tooltip>
                    <input pInputText type="text" id="textField" formControlName="textField">
                  </div>
                } @else if (currentForm().value.type === 'instruction') {
<!--                  Instruction field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_INSTRUCTION_FIELD">Instruction Field</sm-label-tooltip>
                    <input pInputText type="text" id="instructionField" formControlName="instructionField">
                  </div>
<!--                  Input field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_INPUT_FIELD">Input Field</sm-label-tooltip>
                    <input pInputText type="text" id="inputField" formControlName="inputField">
                  </div>
<!--                  Output field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_OUTPUT_FIELD">Output Field</sm-label-tooltip>
                    <input pInputText type="text" id="outputField" formControlName="outputField">
                  </div>
<!--                  System prompt type-->
                  <div class="field col-12 md:col-6">
                    <sm-label-tooltip [tooltip]="DATASET_SYSTEM_PROMPT_TYPE">System prompt type</sm-label-tooltip>
                    <p-dropdown [options]="systemPromptType" id="systemPromptType"
                                formControlName="systemPromptType" appendTo="body"></p-dropdown>
                  </div>
                  @if (currentForm().get('systemPromptType').value === 'field') {
<!--                    System prompt field-->
                    <div class="field col-12 md:col-6">
                      <sm-label-tooltip [tooltip]="DATASET_SYSTEM_PROMPT_FIELD">System prompt field</sm-label-tooltip>
                      <input pInputText type="text" id="systemPromptField" formControlName="systemPromptField">
                    </div>
                  } @else if (currentForm().get('systemPromptType').value === 'fixed') {
                    <div class="field col-12 md:col-6">
<!--                      System prompt-->
                      <label>System prompt</label>
                      <textarea pInputTextarea id="systemPrompt" formControlName="systemPrompt"
                                rows="5" placeholder="eg. Below is an instruction from a USER that describes a task, paired with an input that provides further context. The ASSISTANT writes a response that concisely and appropriately completes the request."></textarea>
                    </div>
<!--                    Prompt format-->
                    <div class="field col-12 md:col-6">
                      <sm-label-tooltip [tooltip]="DATASET_INSTRUCTION_PROMPT_FORMAT">Prompt format</sm-label-tooltip>
                      <textarea pInputTextarea type="text" rows="3" id="promptFormat" formControlName="promptFormat"></textarea>
                    </div>
<!--                    Prompt format no input-->
                    <div class="field col-12 md:col-6">
                      <sm-label-tooltip [tooltip]="DATASET_INSTRUCTION_PROMPT_FORMAT_NO_INPUT">Prompt format (no input)</sm-label-tooltip>
                      <textarea pInputTextarea type="text" rows="3" id="promptFormatNoInput" formControlName="promptFormatNoInput"></textarea>
                    </div>
                  }
                } @else if (currentForm().value.type === 'conversation') {
<!--                  Messages field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_CONVERSATION_FIELD_MESSAGES">Messages field</sm-label-tooltip>
                    <input pInputText type="text" id="messagesField" formControlName="messagesField">
                  </div>
<!--                  System field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_SYSTEM_PROMPT_FIELD">System prompt field</sm-label-tooltip>
                    <input pInputText type="text" id="systemField" formControlName="systemField">
                  </div>
<!--                  Tools field-->
                  <div class="field col-12 md:col-4">
                    <sm-label-tooltip [tooltip]="DATASET_CONVERSATION_FIELD_TOOLS">Tools field</sm-label-tooltip>
                    <input pInputText type="text" id="toolsField" formControlName="toolsField">
                    <small>The field value must be JSON list of objects in the format expected by the chat template.</small>
                  </div>
<!--                  Message property mappings role-->
                  <div class="field col-12 md:col-6">
                    <label>Message field mappings - Role</label>
                    <input pInputText type="text" id="messagePropertyMappingsRole" formControlName="messagePropertyMappingsRole">
                  </div>
<!--                  Message property mappings content-->
                  <div class="field col-12 md:col-6">
                    <label>Message field mappings - Content</label>
                    <input pInputText type="text" id="messagePropertyMappingsContent" formControlName="messagePropertyMappingsContent">
                  </div>
                }
              </div>
            </form>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</sm-card>
