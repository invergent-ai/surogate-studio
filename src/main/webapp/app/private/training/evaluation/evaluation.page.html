<sm-page>
  <sm-page-loader>
    <ng-template>
      <div class="mb-5">
        <h1 class="page-title">Evaluate Model</h1>
        <p class="page-subtitle">Run automatic benchmarks (e.g., MMLU, ARC-AGI, IFâ€‘Bench), safety and custom evals.</p>
      </div>

      <!-- Evaluation Results (show at top when completed) -->
      @if (provisioningStatus() === 'COMPLETED') {
        <div class="mb-4">
          <sm-evaluation-results [taskRunId]="taskRunId()"></sm-evaluation-results>
        </div>
      }

      <form [formGroup]="taskForm" (ngSubmit)="save()">

        <!-- Run Basics Card -->
        <div class="mb-5">
          <sm-card header="Run basics" [icon]="Flame" iconClass="text-orange-500" class="mb-5">
            <div class="formgrid grid text-sm p-fluid">
              <div class="field col-12 md:col-6">
                <sm-label-tooltip [tooltip]="BASE_RUN_NAME">Run name*</sm-label-tooltip>
                <input pInputText type="text" formControlName="name">
                @if (isInvalid(taskForm.get("name"))) {
                  <div class="error-msg">Required field</div>
                }
              </div>
              <div class="field col-12 md:col-3">
                <sm-label-tooltip [tooltip]="EVAL_LANGUAGE">Language (optional)</sm-label-tooltip>
                <p-dropdown formControlName="language" [options]="languages" optionLabel="name"
                            optionValue="code"></p-dropdown>
              </div>
              <div class="field col-12">
                <label>Description</label>
                <textarea pInputTextarea type="text" placeholder="Describe your magic..." rows="3"
                          formControlName="description"></textarea>
              </div>
            </div>

            <!-- Model Under Test Section -->
            <p-divider></p-divider>
            <div class="flex align-items-center gap-2 mb-3">
              <i-lucide [img]="Bot" class="w-1rem h-1rem text-500"></i-lucide>
              <span class="font-medium text-sm">Model Under Test *</span>
            </div>
            <sm-llm-provider-config formControlName="modelUnderTest" [showAdvancedToggle]="true"></sm-llm-provider-config>
            @if (isInvalid(taskForm.get("modelUnderTest"))) {
              <div class="error-msg">Required field</div>
            }

            <!-- Judge & Simulator Models Section -->
            <p-divider></p-divider>
            <div class="flex align-items-center gap-2 mb-3">
              <i-lucide [img]="Bot" class="w-1rem h-1rem text-500"></i-lucide>
              <span class="font-medium text-sm">Judge Model (for Quality Metrics & Red Teaming)</span>
            </div>
            <sm-llm-provider-config formControlName="judgeConfig"></sm-llm-provider-config>

            <!-- Use Separate Simulator Checkbox -->
            <div class="field col-12 mt-3">
              <div class="flex align-items-center gap-2">
                <p-checkbox [binary]="true" formControlName="useSeparateSimulator"
                            inputId="useSeparateSimulator"></p-checkbox>
                <label for="useSeparateSimulator" class="cursor-pointer">
                  Use different model for attack simulation
                </label>
                <sm-label-tooltip
                  tooltip="By default, the Judge Model is used for both evaluation and attack simulation. Enable this to use a separate (often cheaper/faster) model for generating attacks."></sm-label-tooltip>
              </div>
            </div>

            <!-- Simulator Model (conditional) -->
            @if (useSeparateSimulator) {
              <div class="flex align-items-center gap-2 mb-3 mt-3">
                <i-lucide [img]="Bot" class="w-1rem h-1rem text-500"></i-lucide>
                <span class="font-medium text-sm">Simulator Model (Attack Generator)</span>
              </div>
              <sm-llm-provider-config formControlName="simulatorConfig"></sm-llm-provider-config>
            }

            <small class="text-500 block mt-3">
              @if (useSeparateSimulator) {
                Judge model evaluates responses. Simulator model generates adversarial attacks.
              } @else {
                The Judge model will be used for both evaluation and attack simulation.
              }
            </small>
          </sm-card>
        </div>

        <!-- Custom Evaluation Card -->
        <div class="mb-5">
          <sm-card header="Custom Evaluation" [icon]="Settings" iconClass="text-blue-500" class="mb-5">
            <sm-dataset-table-chooser
              [task]="'eval'"
              [title]="'Custom Evaluation Datasets'"
              [formArray]="customEvalDatasetsArray"
              [multiple]="true">
            </sm-dataset-table-chooser>

            @if (customEvalDatasetsArray.length > 0 && !judgeConfig?.model) {
              <p-message severity="warn" styleClass="mt-3 w-full">
                Custom evaluation with judge metrics requires a Judge Model. Configure it in "Run basics" above.
              </p-message>
            }
          </sm-card>
        </div>

        <!-- Conversation Metrics Card -->
        <div class="mb-5">
          <sm-card header="Conversation Metrics" [icon]="MessageSquare" iconClass="text-green-500" class="mb-5">
            <div class="grid">
              @for (item of conversation; track item.name) {
                <div class="col-4">
                  <ng-container [ngTemplateOutlet]="metricCard"
                                [ngTemplateOutletContext]="{item: item, addFn: addConversationMetric.bind(this)}"></ng-container>
                </div>
              }
            </div>

            <div class="flex justify-content-end mt-2">
              <sm-dataset-format-helper [formatType]="'conversation'"></sm-dataset-format-helper>
            </div>


            @if (conversationMetricsArray.length > 0) {
              <div class="mt-3">
                @if (!judgeConfig?.model) {
                  <p-message severity="warn" styleClass="mb-3 w-full">
                    Conversation metrics require a Judge Model to evaluate responses. Configure it in "Run basics" above.
                  </p-message>
                }
                <!-- Conversation Metrics Table -->
                <p-table [value]="conversationMetricsArray.controls"
                         [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th class="text-500">
                        <sm-label-tooltip>Metric</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip [tooltip]="EVAL_CONVERSATION_DATASET">Dataset *</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip tooltip="Metric-specific configuration parameter">Config</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip tooltip="Limit number of samples to evaluate (optional)">Limit</sm-label-tooltip>
                      </th>
                      <th class="text-500">Actions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-group>
                    <tr [formGroup]="group">
                      <td style="width: 160px">
                        <div>{{ group.get('name')?.value }}</div>
                        @if (group.get('hasConfig')?.value && group.get('configLabel')?.value) {
                          <div class="text-xs text-500">{{ group.get('configLabel')?.value }}</div>
                        }
                      </td>
                      <td>
                        <div class="flex gap-2 align-items-center">
                          <sm-repo-selector
                            [repoType]="'dataset'"
                            formControlName="datasetRepo"
                            [maxDisplayLength]="15"
                            class="flex-1">
                          </sm-repo-selector>
                          @if (group.get('datasetRepo')?.value) {
                            <sm-ref-selector
                              type="branch"
                              [repoId]="group.get('datasetRepo')?.value"
                              [buttonSize]="'small'"
                              [canSelect]="true"
                              formControlName="datasetRef"
                              class="flex-1">
                            </sm-ref-selector>
                          }
                        </div>
                        @if (isInvalid(group.get('datasetRepo'))) {
                          <div class="error-msg">Required field</div>
                        }
                      </td>
                      <td style="width: 120px">
                        @if (group.get('hasConfig')?.value) {
                          <div class="flex align-items-center gap-1">
                            <p-inputNumber formControlName="configValue" [minFractionDigits]="0" [maxFractionDigits]="2"
                                           [style]="{'width': '80px'}"></p-inputNumber>
                            @if (group.get('configTooltip')?.value) {
                              <i-lucide [img]="Info" class="w-1rem h-1rem text-400 cursor-help"
                                        [pTooltip]="group.get('configTooltip')?.value" tooltipPosition="top"></i-lucide>
                            }
                          </div>
                        } @else {
                          <span class="text-500">-</span>
                        }
                      </td>
                      <td style="width: 100px">
                        <p-inputNumber formControlName="limit" [min]="1" placeholder="All"></p-inputNumber>
                      </td>
                      <td style="width: 60px">
                        <div class="flex gap-2">
                          <a (click)="removeConversationMetric(group.get('name')?.value)"
                             class="text-red-500 hover:text-red-700 cursor-pointer">
                            <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                          </a>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            }
          </sm-card>
        </div>

        <!-- Accuracy Benchmarks Card -->
        <div class="mb-5">
          <sm-card header="Accuracy" [icon]="GalleryVerticalEnd" iconClass="text-indigo-500" class="mb-5">
            <div class="grid">
              @for (item of benchmarks; track item.name) {
                <div class="col-4">
                  <ng-container [ngTemplateOutlet]="benchmark" [ngTemplateOutletContext]="{item: item}"></ng-container>
                </div>
              }
            </div>
            @if (accuracyBenchmarks.length > 0) {
              <div class="mt-3" formArrayName="benchmarks">
                <p-table [value]="accuracyBenchmarks" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}"
                         styleClass="text-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th class="text-500">Benchmark</th>
                      <th class="text-500">
                        <sm-label-tooltip tooltip="Use a custom dataset from LakeFS instead of the default benchmark dataset">Dataset</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip [tooltip]="EVAL_TASKS">Tasks</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip [tooltip]="EVAL_SHOTS">Shots</sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip tooltip="Limit number of samples (optional)">Limit</sm-label-tooltip>
                      </th>
                      <th class="text-500">Actions</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-group let-i="rowIndex">
                    <tr [formGroup]="group">
                      <td style="width: 140px">
                        {{ group.get('name')?.value }}
                        @if (getBenchmarkMinContext(group.get('name')?.value)) {
                          <div class="text-orange-500 text-xs mt-1">
                            <i-lucide [img]="Info" class="w-0.75rem h-0.75rem inline"></i-lucide>
                            Requires {{ getBenchmarkMinContext(group.get('name')?.value) / 1000 }}K+ context
                          </div>
                        }
                      </td>
                      <td style="width: 320px">
                        <div class="flex flex-column gap-2">
                          <div class="flex align-items-center gap-2">
                            <p-checkbox [binary]="true" formControlName="useCustomDataset" inputId="useCustomDataset_{{i}}"></p-checkbox>
                            <label for="useCustomDataset_{{i}}" class="text-sm cursor-pointer">Custom dataset</label>
                          </div>
                          @if (group.get('useCustomDataset')?.value) {
                            <div class="flex gap-2 align-items-center">
                              <sm-repo-selector
                                [repoType]="'dataset'"
                                formControlName="datasetRepo"
                                [maxDisplayLength]="12"
                                class="flex-1">
                              </sm-repo-selector>
                              @if (group.get('datasetRepo')?.value) {
                                <sm-ref-selector
                                  type="branch"
                                  [repoId]="group.get('datasetRepo')?.value"
                                  [buttonSize]="'small'"
                                  [canSelect]="true"
                                  formControlName="datasetRef"
                                  class="flex-1">
                                </sm-ref-selector>
                              }
                            </div>
                            <div class="flex align-items-center gap-2">
                              <label class="text-xs text-500 white-space-nowrap">Subset:</label>
                              <input pInputText formControlName="datasetSubset" placeholder="default" class="w-full text-sm">
                            </div>
                          } @else {
                            <span class="text-500 text-xs">Using default benchmark dataset</span>
                          }
                        </div>
                      </td>
                      <td>
                        <p-multiSelect
                          [options]="group.get('tasks')?.value"
                          formControlName="selectedTasks"
                          appendTo="body"
                          placeholder="Select tasks">
                        </p-multiSelect>
                      </td>
                      <td style="width: 80px">
                        @if (group.get('supportsFewshot')?.value) {
                          <p-inputNumber formControlName="shots" [min]="0" placeholder="5"></p-inputNumber>
                        } @else {
                          <span class="text-500">N/A</span>
                        }
                      </td>
                      <td style="width: 80px">
                        <p-inputNumber formControlName="limit" [min]="1" placeholder="All"></p-inputNumber>
                      </td>
                      <td style="width: 60px">
                        <a (click)="removeBenchmarkByName(group.get('name')?.value)"
                           class="text-red-500 hover:text-red-700 cursor-pointer">
                          <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                        </a>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
                <small class="text-500 mt-2 block">
                  Custom datasets: Repository branch must contain a JSONL file matching the benchmark format
                </small>
              </div>
            }
          </sm-card>
        </div>

        <!-- Security Red Teaming Card -->
        <div class="mb-5">
          <sm-card header="Security (Red Teaming)" [icon]="ShieldCheck" iconClass="text-red-500" class="mb-5">
            <div class="grid">
              @for (item of security; track item.name) {
                <div class="col-4">
                  <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
                    <div class="flex align-items-center justify-content-between">
                      <div class="flex align-items-center gap-3">
                        <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
                        <div>
                          <div class="font-medium">
                            <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
                          </div>
                          <div class="text-xs text-500">{{ item.type }}</div>
                        </div>
                      </div>
                      <button pButton label="Add" type="button" severity="secondary" class="p-button-xs"
                              (click)="addSecurityTest(item)"></button>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Selected security tests table -->
            @if (securityTestsArray.length > 0) {
              <div class="mt-3">
                @if (!judgeConfig?.model) {
                  <p-message severity="warn" styleClass="mb-3 w-full">
                    <span class="font-medium">Judge Model required:</span> Red teaming needs an external model to generate
                    attacks and evaluate responses. Configure it in "Run basics" above.
                  </p-message>
                }
                @if (useSeparateSimulator && !simulatorConfig?.model) {
                  <p-message severity="warn" styleClass="mb-3 w-full">
                    <span class="font-medium">Simulator Model required:</span> You enabled separate simulator but didn't
                    specify a model. Configure it in "Run basics" above.
                  </p-message>
                }

                <p-table [value]="securityTestsArray.controls" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}"
                         styleClass="text-sm">
                  <ng-template pTemplate="header">
                    <tr>
                      <th class="text-500">Vulnerability</th>
                      <th class="text-500">
                        <sm-label-tooltip
                          tooltip="Select which subtypes to test. Leave all selected for comprehensive testing.">Subtypes
                        </sm-label-tooltip>
                      </th>
                      <th class="text-500">
                        <sm-label-tooltip tooltip="Attack methods to use against this vulnerability.">Attacks
                        </sm-label-tooltip>
                      </th>
                      <th class="text-500">Actions</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-group>
                    <tr [formGroup]="group">
                      <td style="width: 150px">
                        <div class="font-medium">{{ group.get('name')?.value }}</div>
                        <div class="text-xs text-500">{{ group.get('category')?.value }}</div>
                      </td>
                      <td>
                        <p-multiSelect
                          [options]="group.get('subtypesOptions')?.value"
                          formControlName="selectedSubtypes"
                          optionLabel="label"
                          optionValue="value"
                          appendTo="body"
                          placeholder="All subtypes"
                          selectedItemsLabel="{0} selected"
                          [maxSelectedLabels]="2">
                        </p-multiSelect>
                      </td>
                      <td>
                        <p-multiSelect
                          [options]="attacks"
                          formControlName="attacks"
                          optionLabel="label"
                          optionValue="value"
                          appendTo="body"
                          placeholder="Select attacks"
                          selectedItemsLabel="{0} attacks"
                          [maxSelectedLabels]="2">
                        </p-multiSelect>
                      </td>
                      <td style="width: 50px">
                        <a (click)="removeSecurityTest(group.get('name')?.value)"
                           class="text-red-500 hover:text-red-700 cursor-pointer">
                          <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                        </a>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>

                <!-- Red Teaming Configuration -->
                <div class="mt-3 p-3 surface-50 border-round" [formGroup]="redTeamingConfig">
                  <div class="flex align-items-center gap-2 mb-3">
                    <i-lucide [img]="Settings" class="w-1rem h-1rem text-500"></i-lucide>
                    <span class="font-medium text-sm">Red Teaming Configuration</span>
                  </div>
                  <div class="grid text-sm">
                    <div class="col-4">
                      <label class="block mb-1 text-500">Attacks per Vulnerability</label>
                      <p-inputNumber formControlName="attacksPerVulnerability" [min]="1" [max]="10"
                                     [showButtons]="true"></p-inputNumber>
                    </div>
                    <div class="col-4">
                      <label class="block mb-1 text-500">Max Concurrent</label>
                      <p-inputNumber formControlName="maxConcurrent" [min]="1" [max]="20"
                                     [showButtons]="true"></p-inputNumber>
                    </div>
                    <div class="col-4">
                      <label class="block mb-1 text-500">Purpose</label>
                      <input pInputText formControlName="purpose" placeholder="e.g., Customer chatbot">
                    </div>
                  </div>
                </div>

                <small class="text-500 mt-2 block">
                  @if (useSeparateSimulator) {
                    Red teaming uses
                    <strong>{{ simulatorConfig?.model || 'Simulator Model' }}</strong> to generate attacks and
                    <strong>{{ judgeConfig?.model || 'Judge Model' }}</strong> to evaluate success.
                  } @else {
                    Red teaming uses
                    <strong>{{ judgeConfig?.model || 'Judge Model' }}</strong> for both attack generation and evaluation.
                  }
                </small>
              </div>
            }
          </sm-card>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-content-end gap-2 py-4">
          <button pButton size="small" type="submit" outlined class="flex gap-1 px-4" [disabled]="!taskForm.valid">
            <i-lucide [img]="Save" class="w-1rem h-1rem"></i-lucide>
            Save Draft
          </button>
          <button pButton size="small" type="button" class="flex gap-1 px-4" (click)="save(true)"
                  [disabled]="!taskForm.valid || isSaving() || isLaunching()" [loading]="isLaunching()">
            <i-lucide [img]="ArrowRight" class="w-1rem h-1rem"></i-lucide>
            {{ mustRelaunch() ? 'Relaunch' : 'Launch' }}
          </button>
        </div>
      </form>

    </ng-template>
  </sm-page-loader>
</sm-page>

<!-- Benchmark Template -->
<ng-template #benchmark let-item="item">
  <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-4">
        <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
        <div>
          <div class="font-medium">
            <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
          </div>
          <div class="text-xs text-500">{{ item.type }}</div>
        </div>
      </div>
      <button pButton label="Add" type="button" severity="secondary" class="p-button-xs" (click)="add(item)"></button>
    </div>
  </div>
</ng-template>

<!-- Metric Card Template -->
<ng-template #metricCard let-item="item" let-addFn="addFn">
  <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-4">
        <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
        <div>
          <div class="font-medium">
            <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
          </div>
          <div class="text-xs text-500">{{ item.type }}</div>
        </div>
      </div>
      <button pButton label="Add" type="button" severity="secondary" class="p-button-xs" (click)="addFn(item)"></button>
    </div>
  </div>
</ng-template>
