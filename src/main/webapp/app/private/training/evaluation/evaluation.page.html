<sm-page>
  <sm-page-loader>
    <ng-template>
      <div class="mb-5">
        <h1 class="page-title">Evaluate Model</h1>
        <p class="page-subtitle">Run automatic benchmarks (e.g., MMLU, ARC-AGI, IFâ€‘Bench), safety and custom evals.</p>
      </div>

      <div class="grid gap-3">
        <form class="col-8 flex flex-column gap-4" [formGroup]="taskForm" (ngSubmit)="save()">

          <!-- Run Basics Card -->
          <sm-card header="Run basics" [icon]="Flame" iconClass="text-orange-500">
            <div class="formgrid grid text-sm p-fluid">
              <div class="field col-12 md:col-6">
                <sm-label-tooltip [tooltip]="BASE_RUN_NAME">Run name*</sm-label-tooltip>
                <input pInputText type="text" formControlName="name">
                @if (isInvalid(taskForm.get("name"))) {
                  <div class="error-msg">Required field</div>
                }
              </div>
              <div class="field col-12 md:col-6">
                <sm-label-tooltip [tooltip]="EVAL_MODEL_REPOSITORY">Deployed Model *</sm-label-tooltip>
                <sm-deployed-model-selector formControlName="deployedModel" [returnFull]="true"></sm-deployed-model-selector>
                @if (isInvalid(taskForm.get("deployedModel"))) {
                  <div class="error-msg">Required field</div>
                }
              </div>
              <div class="field col-12 md:col-3">
                <sm-label-tooltip [tooltip]="EVAL_USE_GATEWAY_MODEL">Use Gateway Model</sm-label-tooltip>
                <div class="flex h-2rem">
                  <p-checkbox [binary]="true" formControlName="useGateway"></p-checkbox>
                </div>
              </div>
              <div class="field col-12 md:col-3">
                <sm-label-tooltip [tooltip]="EVAL_LANGUAGE">Language (optional)</sm-label-tooltip>
                <p-dropdown formControlName="language" [options]="languages" optionLabel="name" optionValue="code"></p-dropdown>
              </div>
              <div class="field col-12">
                <label>Description</label>
                <textarea pInputTextarea type="text" placeholder="Describe your magic..." rows="3" formControlName="description"></textarea>
              </div>
            </div>

            <!-- Judge & Simulator Models Section -->
            <p-divider></p-divider>
            <div class="flex align-items-center gap-2 mb-3">
              <i-lucide [img]="Bot" class="w-1rem h-1rem text-500"></i-lucide>
              <span class="font-medium text-sm">External Models (for Quality Metrics & Red Teaming)</span>
            </div>
            <div class="formgrid grid text-sm p-fluid">
              <!-- Judge Model -->
              <div class="field col-12 md:col-4">
                <sm-label-tooltip tooltip="Model name used to evaluate response quality and judge attack success. Example: gpt-4o-mini">
                  Judge Model
                </sm-label-tooltip>
                <input pInputText type="text" formControlName="judgeModel" placeholder="e.g., gpt-4o-mini">
              </div>
              <div class="field col-12 md:col-4">
                <sm-label-tooltip tooltip="Base URL for the judge model API. Leave empty for OpenAI default.">
                  Judge Base URL
                </sm-label-tooltip>
                <input pInputText type="text" formControlName="judgeModelBaseUrl" placeholder="https://api.openai.com/v1">
              </div>
              <div class="field col-12 md:col-4">
                <sm-label-tooltip tooltip="API key for the judge model endpoint.">
                  Judge API Key
                </sm-label-tooltip>
                <input pInputText type="password" formControlName="judgeModelApi" placeholder="sk-...">
              </div>

              <!-- Use Separate Simulator Checkbox -->
              <div class="field col-12">
                <div class="flex align-items-center gap-2">
                  <p-checkbox [binary]="true" formControlName="useSeparateSimulator" inputId="useSeparateSimulator"></p-checkbox>
                  <label for="useSeparateSimulator" class="cursor-pointer">
                    Use different model for attack simulation
                  </label>
                  <sm-label-tooltip tooltip="By default, the Judge Model is used for both evaluation and attack simulation. Enable this to use a separate (often cheaper/faster) model for generating attacks."></sm-label-tooltip>
                </div>
              </div>

              <!-- Simulator Model (conditional) -->
              @if (taskForm.get('useSeparateSimulator')?.value) {
                <div class="field col-12 md:col-4">
                  <sm-label-tooltip tooltip="Model used to generate adversarial attacks. A faster/cheaper model like gpt-3.5-turbo is often sufficient.">
                    Simulator Model (Attacker)
                  </sm-label-tooltip>
                  <input pInputText type="text" formControlName="simulatorModel" placeholder="e.g., gpt-3.5-turbo">
                </div>
                <div class="field col-12 md:col-4">
                  <sm-label-tooltip tooltip="Base URL for the simulator model API. Leave empty to use same as Judge.">
                    Simulator Base URL
                  </sm-label-tooltip>
                  <input pInputText type="text" formControlName="simulatorModelBaseUrl" placeholder="Same as Judge">
                </div>
                <div class="field col-12 md:col-4">
                  <sm-label-tooltip tooltip="API key for the simulator model. Leave empty to use same as Judge.">
                    Simulator API Key
                  </sm-label-tooltip>
                  <input pInputText type="password" formControlName="simulatorModelApi" placeholder="Same as Judge">
                </div>
              }
            </div>
            <small class="text-500 block">
              @if (taskForm.get('useSeparateSimulator')?.value) {
                Judge model evaluates responses. Simulator model generates adversarial attacks.
              } @else {
                The Judge model will be used for both evaluation and attack simulation.
              }
            </small>
          </sm-card>

          <!-- Custom Evaluation Card (Coming Soon) -->
          <sm-card header="Custom Evaluation" [icon]="Settings">
            <div class="flex flex-column align-items-center justify-content-center py-5 text-center">
              <i-lucide [img]="Settings" class="w-3rem h-3rem text-400 mb-3"></i-lucide>
              <h3 class="text-600 mb-2">Custom Dataset Evaluation</h3>
              <p class="text-500 mb-0">
                Evaluate your model on any custom dataset with flexible column mappings and scoring methods.
              </p>
              <p-tag severity="warning" value="Coming Soon" class="mt-3"></p-tag>
            </div>
          </sm-card>

          <!-- Quality Metrics Card -->
          <sm-card header="Quality Metrics" [icon]="Sparkles">
            <div class="grid">
              <div *ngFor="let item of quality" class="col-4">
                <ng-container [ngTemplateOutlet]="metricCard" [ngTemplateOutletContext]="{item: item, addFn: addQualityMetric.bind(this)}"></ng-container>
              </div>
            </div>
            <div class="mt-3" *ngIf="qualityMetricsArray.length > 0">
              @if (!taskForm.get('judgeModel')?.value) {
                <p-message severity="warn" styleClass="mb-3 w-full">
                  Quality metrics require a Judge Model to evaluate responses. Configure it in "Run basics" above.
                </p-message>
              }
              <p-table [value]="qualityMetricsArray.controls" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-500">
                      <sm-label-tooltip>Metric</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip [tooltip]="EVAL_QUALITY_DATASET">Dataset *</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Path to JSONL file in the repository">File Path *</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip [tooltip]="EVAL_CUSTOM_CRITERIA">Custom Criteria (optional)</sm-label-tooltip>
                    </th>
                    <th class="text-500">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-group>
                  <tr [formGroup]="group">
                    <td style="width: 120px">{{ group.get('name')?.value }}</td>
                    <td>
                      <div class="flex gap-2 align-items-center">
                        <sm-repo-selector
                          [repoType]="'dataset'"
                          formControlName="datasetRepo"
                          [maxDisplayLength]="15"
                          class="flex-1">
                        </sm-repo-selector>
                        @if (group.get('datasetRepo')?.value) {
                          <sm-ref-selector
                            type="branch"
                            [repoId]="group.get('datasetRepo')?.value"
                            [buttonSize]="'small'"
                            [canSelect]="true"
                            formControlName="datasetRef"
                            class="flex-1">
                          </sm-ref-selector>
                        }
                      </div>
                      @if (isInvalid(group.get('datasetRepo'))) {
                        <div class="error-msg">Required field</div>
                      }
                    </td>
                    <td style="width: 180px">
                      <input pInputText formControlName="datasetPath" placeholder="e.g., data/eval.jsonl">
                      @if (isInvalid(group.get('datasetPath'))) {
                        <div class="error-msg">Required field</div>
                      }
                    </td>
                    <td>
                      <input pInputText formControlName="criteria" placeholder="e.g., Does the output correctly answer the input?">
                    </td>
                    <td style="width: 60px">
                      <div class="flex gap-2">
                        <a (click)="removeQualityMetric(group.get('name')?.value)" class="text-red-500 hover:text-red-700 cursor-pointer">
                          <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                        </a>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
              <small class="text-500 mt-2 block">
                Dataset format: JSONL with <code>input</code>, <code>expected_output</code> fields
              </small>
            </div>
          </sm-card>

          <!-- Conversation Metrics Card -->
          <!-- Conversation Metrics Card -->
          <sm-card header="Conversation Metrics" [icon]="MessageSquare">
            <div class="grid">
              <div *ngFor="let item of conversation" class="col-4">
                <ng-container [ngTemplateOutlet]="metricCard" [ngTemplateOutletContext]="{item: item, addFn: addConversationMetric.bind(this)}"></ng-container>
              </div>
            </div>
            <div class="mt-3" *ngIf="conversationMetricsArray.length > 0">
              @if (!taskForm.get('judgeModel')?.value) {
                <p-message severity="warn" styleClass="mb-3 w-full">
                  Conversation metrics require a Judge Model to evaluate responses. Configure it in "Run basics" above.
                </p-message>
              }
              <p-table [value]="conversationMetricsArray.controls" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-500">
                      <sm-label-tooltip>Metric</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip [tooltip]="EVAL_CONVERSATION_DATASET">Dataset *</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Path to JSONL file in the repository">File Path *</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Metric-specific configuration parameter">Config</sm-label-tooltip>
                    </th>
                    <th class="text-500">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-group>
                  <tr [formGroup]="group">
                    <td style="width: 160px">
                      <div>{{ group.get('name')?.value }}</div>
                      @if (group.get('hasConfig')?.value && group.get('configLabel')?.value) {
                        <div class="text-xs text-500">{{ group.get('configLabel')?.value }}</div>
                      }
                    </td>
                    <td>
                      <div class="flex gap-2 align-items-center">
                        <sm-repo-selector
                          [repoType]="'dataset'"
                          formControlName="datasetRepo"
                          [maxDisplayLength]="15"
                          class="flex-1">
                        </sm-repo-selector>
                        @if (group.get('datasetRepo')?.value) {
                          <sm-ref-selector
                            type="branch"
                            [repoId]="group.get('datasetRepo')?.value"
                            [buttonSize]="'small'"
                            [canSelect]="true"
                            formControlName="datasetRef"
                            class="flex-1">
                          </sm-ref-selector>
                        }
                      </div>
                      @if (isInvalid(group.get('datasetRepo'))) {
                        <div class="error-msg">Required field</div>
                      }
                    </td>
                    <td style="width: 180px">
                      <input pInputText formControlName="datasetPath" placeholder="e.g., data/conversations.jsonl">
                      @if (isInvalid(group.get('datasetPath'))) {
                        <div class="error-msg">Required field</div>
                      }
                    </td>
                    <td style="width: 120px">
                      @if (group.get('hasConfig')?.value) {
                        <div class="flex align-items-center gap-1">
                          <p-inputNumber formControlName="configValue" [minFractionDigits]="0" [maxFractionDigits]="2" [style]="{'width': '80px'}"></p-inputNumber>
                          @if (group.get('configTooltip')?.value) {
                            <i-lucide [img]="Info" class="w-1rem h-1rem text-400 cursor-help" [pTooltip]="group.get('configTooltip')?.value" tooltipPosition="top"></i-lucide>
                          }
                        </div>
                      } @else {
                        <span class="text-500">-</span>
                      }
                    </td>
                    <td style="width: 60px">
                      <div class="flex gap-2">
                        <a (click)="removeConversationMetric(group.get('name')?.value)" class="text-red-500 hover:text-red-700 cursor-pointer">
                          <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                        </a>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
              <small class="text-500 mt-2 block">
                Dataset format: JSONL with <code>turns</code> array containing objects with <code>role</code> and <code>content</code> fields
              </small>
            </div>
          </sm-card>

          <!-- Accuracy Benchmarks Card -->
          <sm-card header="Accuracy" [icon]="GalleryVerticalEnd">
            <div class="grid">
              <div *ngFor="let item of benchmarks" class="col-4">
                <ng-container [ngTemplateOutlet]="benchmark" [ngTemplateOutletContext]="{item: item}"></ng-container>
              </div>
            </div>
            <div class="mt-3" formArrayName="benchmarks" *ngIf="accuracyBenchmarks.length > 0">
              <p-table [value]="accuracyBenchmarks" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-500">Benchmark</th>
                    <th class="text-500">
                      <sm-label-tooltip [tooltip]="EVAL_TASKS">Tasks</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip [tooltip]="EVAL_SHOTS">Shots</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Limit number of samples (optional)">Limit</sm-label-tooltip>
                    </th>
                    <th class="text-500">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-group let-i="rowIndex">
                  <tr [formGroup]="group">
                    <td>
                      {{ group.get('name')?.value }}
                      @if (getBenchmarkMinContext(group.get('name')?.value)) {
                        <div class="text-orange-500 text-xs mt-1">
                          <i-lucide [img]="Info" class="w-0.75rem h-0.75rem inline"></i-lucide>
                          Requires {{ getBenchmarkMinContext(group.get('name')?.value) / 1000 }}K+ context
                        </div>
                      }
                    </td>
                    <td>
                      <p-multiSelect
                        [options]="group.get('tasks')?.value"
                        formControlName="selectedTasks"
                        appendTo="body"
                        placeholder="Select tasks">
                      </p-multiSelect>
                    </td>
                    <td style="width: 80px">
                      @if (group.get('supportsFewshot')?.value) {
                        <p-inputNumber formControlName="shots" [min]="0" placeholder="5"></p-inputNumber>
                      } @else {
                        <span class="text-500">N/A</span>
                      }
                    </td>
                    <td style="width: 80px">
                      <p-inputNumber formControlName="limit" [min]="1" placeholder="All"></p-inputNumber>
                    </td>
                    <td style="width: 60px">
                      <a (click)="removeBenchmarkByName(group.get('name')?.value)" class="text-red-500 hover:text-red-700 cursor-pointer">
                        <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                      </a>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </sm-card>

          <!-- Security Red Teaming Card -->
          <sm-card header="Security (Red Teaming)" [icon]="ShieldCheck">
            <div class="grid">
              <div *ngFor="let item of security" class="col-4">
                <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
                  <div class="flex align-items-center justify-content-between">
                    <div class="flex align-items-center gap-3">
                      <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
                      <div>
                        <div class="font-medium">
                          <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
                        </div>
                        <div class="text-xs text-500">{{ item.type }}</div>
                      </div>
                    </div>
                    <button pButton label="Add" type="button" severity="secondary" class="p-button-xs" (click)="addSecurityTest(item)"></button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Selected security tests table -->
            <div class="mt-3" *ngIf="securityTestsArray.length > 0">
              <!-- Warning if no judge model configured -->
              @if (!taskForm.get('judgeModel')?.value) {
                <p-message severity="warn" styleClass="mb-3 w-full">
                  <span class="font-medium">Judge Model required:</span> Red teaming needs an external model to generate attacks and evaluate responses. Configure it in "Run basics" above.
                </p-message>
              }
              @if (taskForm.get('useSeparateSimulator')?.value && !taskForm.get('simulatorModel')?.value) {
                <p-message severity="warn" styleClass="mb-3 w-full">
                  <span class="font-medium">Simulator Model required:</span> You enabled separate simulator but didn't specify a model. Configure it in "Run basics" above.
                </p-message>
              }

              <p-table [value]="securityTestsArray.controls" [tableStyle]="{'table-layout': 'auto', 'width': '100%'}" styleClass="text-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-500">Vulnerability</th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Select which subtypes to test. Leave all selected for comprehensive testing.">Subtypes</sm-label-tooltip>
                    </th>
                    <th class="text-500">
                      <sm-label-tooltip tooltip="Attack methods to use against this vulnerability.">Attacks</sm-label-tooltip>
                    </th>
                    <th class="text-500">Actions</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-group>
                  <tr [formGroup]="group">
                    <td style="width: 150px">
                      <div class="font-medium">{{ group.get('name')?.value }}</div>
                      <div class="text-xs text-500">{{ group.get('category')?.value }}</div>
                    </td>
                    <td>
                      <p-multiSelect
                        [options]="group.get('subtypesOptions')?.value"
                        formControlName="selectedSubtypes"
                        optionLabel="label"
                        optionValue="value"
                        appendTo="body"
                        placeholder="All subtypes"
                        selectedItemsLabel="{0} selected"
                        [maxSelectedLabels]="2">
                      </p-multiSelect>
                    </td>
                    <td>
                      <p-multiSelect
                        [options]="attacks"
                        formControlName="attacks"
                        optionLabel="label"
                        optionValue="value"
                        appendTo="body"
                        placeholder="Select attacks"
                        selectedItemsLabel="{0} attacks"
                        [maxSelectedLabels]="2">
                      </p-multiSelect>
                    </td>
                    <td style="width: 50px">
                      <a (click)="removeSecurityTest(group.get('name')?.value)" class="text-red-500 hover:text-red-700 cursor-pointer">
                        <i-lucide [img]="Trash" class="w-1rem h-1rem"></i-lucide>
                      </a>
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <!-- Red Teaming Configuration -->
              <div class="mt-3 p-3 surface-50 border-round" [formGroup]="redTeamingConfig">
                <div class="flex align-items-center gap-2 mb-3">
                  <i-lucide [img]="Settings" class="w-1rem h-1rem text-500"></i-lucide>
                  <span class="font-medium text-sm">Red Teaming Configuration</span>
                </div>
                <div class="grid text-sm">
                  <div class="col-4">
                    <label class="block mb-1 text-500">Attacks per Vulnerability</label>
                    <p-inputNumber formControlName="attacksPerVulnerability" [min]="1" [max]="10" [showButtons]="true"></p-inputNumber>
                  </div>
                  <div class="col-4">
                    <label class="block mb-1 text-500">Max Concurrent</label>
                    <p-inputNumber formControlName="maxConcurrent" [min]="1" [max]="20" [showButtons]="true"></p-inputNumber>
                  </div>
                  <div class="col-4">
                    <label class="block mb-1 text-500">Purpose</label>
                    <input pInputText formControlName="purpose" placeholder="e.g., Customer chatbot">
                  </div>
                </div>
              </div>

              <small class="text-500 mt-2 block">
                @if (taskForm.get('useSeparateSimulator')?.value) {
                  Red teaming uses <strong>{{ taskForm.get('simulatorModel')?.value || 'Simulator Model' }}</strong> to generate attacks and <strong>{{ taskForm.get('judgeModel')?.value || 'Judge Model' }}</strong> to evaluate success.
                } @else {
                  Red teaming uses <strong>{{ taskForm.get('judgeModel')?.value || 'Judge Model' }}</strong> for both attack generation and evaluation.
                }
              </small>
            </div>
          </sm-card>

          <!-- Action Buttons -->
          <div class="flex justify-content-between align-items-center">
            <p class="text-500">Config is saved as a draft until launch.</p>
            <div class="flex gap-2">
              <button pButton size="small" type="submit" outlined class="flex gap-1" [disabled]="!taskForm.valid">
                <i-lucide [img]="Save" class="w-1rem h-1rem"></i-lucide>
                Save Draft
              </button>
              <button pButton size="small" type="button" class="flex gap-1" (click)="save(true)" [disabled]="!taskForm.valid || isSaving() || isLaunching()" [loading]="isLaunching()">
                <i-lucide [img]="ArrowRight" class="w-1rem h-1rem"></i-lucide>
                {{ mustRelaunch() ? 'Relaunch' : 'Launch' }}
              </button>
            </div>
          </div>
        </form>

        <!-- Sidebar -->
        <div class="col">
          <div class="flex flex-column gap-4">
            <sm-card header="Run summary" [icon]="ClipboardList">
              <ng-template pTemplate="toolbar">
                <p-tag severity="secondary" rounded value="Draft"></p-tag>
              </ng-template>
              <div class="flex flex-column gap-2">
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Run</p>
                  <p class="font-semibold">{{ taskForm.get('name')?.value || '-' }}</p>
                </div>
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Model</p>
                  <p class="font-semibold">{{ taskForm.get('deployedModel')?.value?.name || '-' }}</p>
                </div>
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Benchmarks</p>
                  <p class="font-semibold">{{ benchmarksArray.length }}</p>
                </div>
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Quality Metrics</p>
                  <p class="font-semibold">{{ qualityMetricsArray.length }}</p>
                </div>
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Security Tests</p>
                  <p class="font-semibold">{{ securityTestsArray.length }}</p>
                </div>
                <div class="flex justify-content-between text-sm">
                  <p class="text-500">Status</p>
                  <p-tag [severity]="getStatusSeverity()" [value]="provisioningStatus() || 'Draft'"></p-tag>
                </div>
              </div>
            </sm-card>

            <!-- External Models Summary -->
            @if (taskForm.get('judgeModel')?.value) {
              <sm-card header="External Models" [icon]="Bot">
                <div class="flex flex-column gap-2 text-sm">
                  <div class="flex justify-content-between">
                    <p class="text-500">Judge</p>
                    <div class="text-right">
                      <p class="font-semibold">{{ taskForm.get('judgeModel')?.value }}</p>
                      @if (taskForm.get('judgeModelBaseUrl')?.value) {
                        <p class="text-xs text-400">{{ taskForm.get('judgeModelBaseUrl')?.value }}</p>
                      }
                    </div>
                  </div>
                  @if (taskForm.get('useSeparateSimulator')?.value && taskForm.get('simulatorModel')?.value) {
                    <div class="flex justify-content-between">
                      <p class="text-500">Simulator</p>
                      <div class="text-right">
                        <p class="font-semibold">{{ taskForm.get('simulatorModel')?.value }}</p>
                        @if (taskForm.get('simulatorModelBaseUrl')?.value) {
                          <p class="text-xs text-400">{{ taskForm.get('simulatorModelBaseUrl')?.value }}</p>
                        }
                      </div>
                    </div>
                  } @else {
                    <div class="flex justify-content-between">
                      <p class="text-500">Simulator</p>
                      <p class="font-semibold text-400">Same as Judge</p>
                    </div>
                  }
                </div>
              </sm-card>
            }

            <!-- Evaluation Results (show when completed) -->
            @if (provisioningStatus() === 'COMPLETED') {
              <sm-evaluation-results [taskRunId]="taskRunId()"></sm-evaluation-results>
            }

            <sm-job-notification-settings [selectedNotification]="taskForm.get('notify')?.value" (notifyChange)="onNotifyChange($event)"></sm-job-notification-settings>
          </div>
        </div>
      </div>

    </ng-template>
  </sm-page-loader>
</sm-page>

<!-- Benchmark Template -->
<ng-template #benchmark let-item="item">
  <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-4">
        <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
        <div>
          <div class="font-medium">
            <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
          </div>
          <div class="text-xs text-500">{{ item.type }}</div>
        </div>
      </div>
      <button pButton label="Add" type="button" severity="secondary" class="p-button-xs" (click)="add(item)"></button>
    </div>
  </div>
</ng-template>

<!-- Metric Card Template -->
<ng-template #metricCard let-item="item" let-addFn="addFn">
  <div class="card border-round-xl border-1 border-300 text-sm py-3 px-3 mb-2">
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-4">
        <i-lucide [img]="item.img" class="w-1.5rem h-1.5rem"></i-lucide>
        <div>
          <div class="font-medium">
            <sm-label-tooltip [tooltip]="item.tooltip">{{ item.name }}</sm-label-tooltip>
          </div>
          <div class="text-xs text-500">{{ item.type }}</div>
        </div>
      </div>
      <button pButton label="Add" type="button" severity="secondary" class="p-button-xs" (click)="addFn(item)"></button>
    </div>
  </div>
</ng-template>
