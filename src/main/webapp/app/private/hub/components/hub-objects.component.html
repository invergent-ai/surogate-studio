<div class="mb-5">
  <p-card>
    <div class="flex justify-content-between">
      <div class="col">
        <div class="flex gap-3 align-items-center">
          <sm-ref-selector type="any" buttonSize="small" [canSelect]="true" [repoId]="repository().id" [ngModel]="selectedRef()"
                           (ngModelChange)="chooseRef($event)"></sm-ref-selector>

          @if (selectedRef()?.metadata?.source_model) {
            <p-tag severity="success">
              <p>Trained by Surogate</p>
            </p-tag>
          }
          @if (selectedRef()?.metadata?.lora_adapter === 'true') {
            <p-tag severity="info">
              <p>LoRA adapter</p>
            </p-tag>
          }

          <div *ngIf="showBreadcrumb()" class="flex gap-2">
            <a class="hover:underline hover:text-primary-800 font-medium"
               (click)="selectRootFolder()">{{getRepoName()}}</a>

            @for (node of breadcrumb(); track node.key) {
              <span>/</span>
              <a class="hover:underline hover:text-primary-800 font-medium"
                 (click)="selectFolderFromBreadcrumb(node)">{{ node.label }}</a>
            }
            @if (selectedFile(); as file) {
              <span>/</span>
              <span>{{ file.label }}</span>
            }
          </div>
        </div>
      </div>

      <div class="col-4 flex gap-2 align-items-center justify-content-end">
        <button pButton size="small" outlined (click)="refresh()">
          <i-lucide [img]="RefreshCw" class="w-1rem h-1rem"></i-lucide> &nbsp; Refresh
        </button>
        <button pButton size="small" (click)="showAddFileDialog()">
          <i-lucide [img]="Upload" class="w-1rem h-1rem"></i-lucide> &nbsp; Add File
        </button>
        <button pButton size="small" outlined disabled>
          <i-lucide [img]="Download" class="w-1rem h-1rem"></i-lucide> &nbsp; Download as Zip
        </button>
      </div>
    </div>
  </p-card>
</div>

<p-card class="block">
  <ng-template pTemplate="header">
    <div class="p-3 surface-100">
      <p class="font-semibold">lakefs://{{ repository().id }}/{{ selectedRef()?.id }}</p>
    </div>
  </ng-template>

  <div>
    @if (selectedFile()) {
      <sm-file-renderer [object]="selectedFile().data" [ref]="selectedRef()?.id"
                        [repository]="repository()"></sm-file-renderer>
    } @else {
      <sm-file-navigator [objects]="objects()" [selectedPath]="selectedFolder()"
                         [repository]="repository()"
                         (onSelectFile)="onSelectFile($event)"
                         (onSelectFolder)="onSelectFolder($event)"
                         (onFileAction)="onFileAction($event)"></sm-file-navigator>
    }
  </div>
</p-card>
<p-card *ngIf="readmeText() && !selectedFile()" class="mt-5 block">
  <ng-template pTemplate="header">
    <div class="p-3 surface-100">
      <p class="font-semibold">README.MD</p>
    </div>
  </ng-template>
  <sm-markdown-renderer
    [repoId]="repository().id"
    [refId]="selectedRef()?.id"
    [text]="readmeText()">
  </sm-markdown-renderer>

</p-card>

<p-dialog header="Add files" [(visible)]="addFileDialogVisible" [modal]="true"
          [style]="{ width: '30vw' }" [closable]="true" [closeOnEscape]="true"
          [draggable]="false" [resizable]="false">
  <p class="text-sm text-500">Upload files to the repository.</p>

  <form [formGroup]="commitForm">
    <div class="mt-3">
      <div class="field p-fluid">
        <label for="path">Path</label>
        <input pInputText id="path" formControlName="path" placeholder="Path in repository..."/>
      </div>
    </div>

    <div class="mt-3">
      <div class="field p-fluid">
        <label for="message">Commit Message</label>
        <input pInputText id="message" formControlName="message" placeholder="Enter a commit message..."/>
      </div>
    </div>
  </form>

  <div>
    <sm-file-uploader [parallel]="true" [multiple]="true" [maxFileSize]="10 * 1024 * 1024 * 1024"
                      [disabled]="!commitForm.valid"
                      [withCredentials]="true" name="content" (onUploadComplete)="uploadComplete()"
                      [urlModifier]="uploadUrlModifier.bind(this)"
                      [headers]="directLakeFsService.authHeaders()"></sm-file-uploader>
  </div>
</p-dialog>

<p-dialog header="Delete file" [(visible)]="deleteFileDialogVisible" [modal]="true"
          [style]="{ width: '30vw' }" [closable]="true" [closeOnEscape]="true"
          [draggable]="false" [resizable]="false">
  <p class="text-sm text-500">Delete file from repository.</p>

  <form [formGroup]="deleteForm">
    <div class="mt-3">
      <div class="field p-fluid">
        <label for="path">Commit Message</label>
        <input pInputText formControlName="message" placeholder="Enter a commit message..."/>
      </div>
    </div>
  </form>

  <div class="flex gap-2 justify-content-center">
    <button pButton outlined size="small" label="Cancel" (click)="deleteFileDialogVisible.set(false)"></button>
    <button pButton severity="danger" size="small" label="Delete" [disabled]="!deleteForm.valid"
            (click)="deleteFile()"></button>
  </div>
</p-dialog>
